<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.living_spot.house.repository.mybatis.HouseMapper">

    <!-- HouseInfoDto에 대한 resultMap 정의 -->
    <resultMap id="HouseInfoResultMap" type="com.ssafy.living_spot.house.dto.HouseInfoDto">
        <id property="aptSeq" column="apt_seq"/>
        <result property="sggCd" column="sgg_cd"/>
        <result property="umdCd" column="umd_cd"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNmSggCd" column="road_nm_sgg_cd"/>
        <result property="roadNm" column="road_nm"/>
        <result property="roadNmBonbun" column="road_nm_bonbun"/>
        <result property="roadNmBubun" column="road_nm_bubun"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
    </resultMap>

    <!-- HouseDealDto에 대한 resultMap 정의 및 HouseInfoDto와의 association 매핑 -->
    <resultMap id="HouseDealResultMap" type="com.ssafy.living_spot.house.dto.HouseDealDto">
        <id property="no" column="no"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="dealYear" column="deal_year"/>
        <result property="dealMonth" column="deal_month"/>
        <result property="dealDay" column="deal_day"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>

        <!-- houseInfo를 포함하는 association 설정 -->
        <association property="houseInfo" column="apt_seq" javaType="com.ssafy.living_spot.house.dto.HouseInfoDto" select="getHouseInfoByAptSeq"/>
    </resultMap>

    <!-- 모든 HouseDeal을 조회하는 쿼리 -->
    <select id="searchAll" resultMap="HouseDealResultMap">
        SELECT
            d.no, d.apt_seq, d.apt_dong, d.floor, d.deal_year, d.deal_month, d.deal_day, d.exclu_use_ar, d.deal_amount,
            i.apt_seq AS i_apt_seq, i.sgg_cd, i.umd_cd, i.umd_nm, i.jibun, i.road_nm_sgg_cd, i.road_nm,
            i.road_nm_bonbun, i.road_nm_bubun, i.apt_nm, i.build_year, i.latitude, i.longitude
        FROM
            housedeals d
                LEFT JOIN
            houseinfos i ON d.apt_seq = i.apt_seq
    </select>

    <!-- 단일 HouseInfoDto를 조회하는 쿼리 (association을 위한 쿼리) -->
    <select id="findByAptName" resultMap="HouseInfoResultMap" parameterType="String">
        SELECT
            apt_seq, sgg_cd, umd_cd, umd_nm, jibun, road_nm_sgg_cd, road_nm, road_nm_bonbun, road_nm_bubun,
            apt_nm, build_year, latitude, longitude
        FROM
            houseinfos
        WHERE
            apt_nm LIKE CONCAT('%', #{aptName}, '%')
    </select>

</mapper>
